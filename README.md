# 提交订单

业务流程：订单服务 创建订单 -> 库存服务 锁库存

调用库存服务锁库存是一个**远程更新操作**，如果扣减库存成功了，但是由于**网络原因**超时，出现异常，导致订单事务回滚，就会出现数据不一致

## Seata 分布式事务

引入 Seata 分布式事务框架，将创建订单、锁库存放在一个全局事务中，要么全部成功要么全部失败

缺点：不适合高并发场景。AT 模式的实现依赖数据库锁机制，本地事务依赖行锁来实现读写隔离，提交订单的业务流程涉及到创建订单，锁库存等等，订单是用户维度的数据，并发度不高；但库存记录是 sku 级别的，加全局锁很容易让后续的提交订单业务都阻塞

## 可靠消息通知

使用 RabbitMQ 通过设置队列的`TTL` + 死信路由实现延迟队列，数据库乐观锁保证消费幂等性

容忍一段时间的不一致，保证订单和库存的最终一致性

### 定时关单流程

定时关单是订单超过一段时间后未处理，将订单关闭并回滚库存

![](/doc/定时关单流程.png)

### 定时回滚库存流程

定时回滚库存是发生订单创建失败，库存扣减成功后的补偿操作。比如关单消息变成死信的时间是30分钟，回滚库存的消息需要50分钟
在回滚库存消费者判断：1、是否有订单，没有就回滚库存 2、订单是否完成，没有就回滚库存

![](/doc/定时回滚库存流程.png)

### 缺点

存在不一致的情况：如果在提交订单后，订单服务的 MQ 消费端宕机，没有关闭订单，库存的 MQ 因为判断订单没有被取消，不会回滚库存，此时如果订单服务 MQ 消费者恢复正常，将订单关闭，会发生订单和库存不一致

降低上述情况的发生的概率策略之一，就是让库存队列的消息存活时间更长比订单队列的消息存活时间更长，让订单服务 MQ 消费者先于库存服务 MQ 消费